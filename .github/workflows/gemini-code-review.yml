name: Gemini Code Review

on:
  push:
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Gemini CLI
      run: |
        npm install -g @google/gemini-cli
        
    - name: Get changed files
      run: |
        echo "=== Git diff analysis ==="
        # Use GitHub event context to get all changes in this push
        git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
        echo "All changed files in this push:"
        cat changed_files.txt
        
        echo -e "\n=== File status check ==="
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            if [ -f "$file" ]; then
              echo "âœ… EXISTS: $file ($(wc -l < "$file") lines)"
            else
              echo "âŒ MISSING: $file (deleted or moved)"
            fi
          fi
        done < changed_files.txt
        
    - name: Review code with Gemini
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # Debug: Show API key status
        echo "API Key status: $(if [ -n "$GEMINI_API_KEY" ]; then echo "Set (${#GEMINI_API_KEY} chars)"; else echo "Empty"; fi)"
        
        echo "=== Starting code review ==="
        review_count=0
        failed_count=0
        
        # Review each existing file directly from changed_files.txt
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "=== Reviewing file: $file ==="
            
            # Enhanced Gemini CLI with stability options
            if cat "$file" | gemini \
              --model "gemini-2.5-pro" \
              --debug false \
              --telemetry false \
              --checkpointing false \
              -p "è«‹ä¾æ“šå®‰å…¨ç¨‹å¼ç¢¼é–‹ç™¼æ¨™æº–ï¼Œæ·±å…¥æª¢æŸ¥ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼Œæ˜Žç¢ºæŒ‡å‡ºæ‰€æœ‰æ½›åœ¨å•é¡Œï¼ˆå¦‚å®‰å…¨æ€§ã€éŒ¯èª¤è™•ç†ã€å¯ç¶­è­·æ€§ç­‰ï¼‰ï¼Œä¸¦é‡å°æ¯å€‹å•é¡Œæä¾›å…·é«”è§£æ±ºæ–¹æ¡ˆã€‚è«‹å°‡å•é¡Œèˆ‡ä¿®æ­£å»ºè­°ä»¥è¡¨æ ¼æ–¹å¼å‘ˆç¾ï¼ŒåŒ…å«ã€Žé¢¨éšªç­‰ç´šã€ã€ã€Žå•é¡Œæè¿°ã€ã€ã€Žä¿®æ­£å»ºè­°ã€ä¸‰æ¬„ã€‚æœ€å¾Œè«‹ç¶œåˆç¸½çµæœ¬æ¬¡æª¢æŸ¥ç™¼ç¾çš„ä¸»è¦å•é¡ŒåŠå»ºè­°ã€‚"; then
              review_count=$((review_count + 1))
              echo "âœ… Successfully reviewed: $file"
            else
              failed_count=$((failed_count + 1))
              echo "âŒ Failed to review: $file"
              
              # Retry once with simplified prompt
              echo "ðŸ”„ Retrying with simplified prompt..."
              if cat "$file" | gemini \
                --model "gemini-2.5-pro" \
                --debug false \
                --telemetry false \
                -p "è«‹ç°¡çŸ­ review é€™æ®µç¨‹å¼ç¢¼çš„ä¸»è¦å•é¡Œï¼š"; then
                review_count=$((review_count + 1))
                echo "âœ… Retry successful: $file"
              else
                echo "âŒ Retry failed: $file"
              fi
            fi
            
            echo "================================"
          else
            echo "Skipping $file (not found or deleted)"
          fi
        done < changed_files.txt
        
        echo "=== Review Summary ==="
        echo "Total files reviewed: $review_count"
        echo "Failed reviews: $failed_count"
        echo "Success rate: $(( review_count * 100 / (review_count + failed_count) ))%" || echo "Success rate: N/A"
