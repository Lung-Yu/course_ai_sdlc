name: Gemini Code Review

on:
  push:
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Gemini CLI
      run: |
        npm install -g @google/gemini-cli
        
    - name: Get changed files
      run: |
        git diff --name-only HEAD~1 HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
        
    - name: Review code with Gemini
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
        
        # Simple review using gemini CLI
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "Reviewing file: $file"
            gemini chat "請簡短審查這個程式碼檔案的問題: $(cat "$file")" || echo "Review failed for $file"
          fi
        done < changed_files.txt
