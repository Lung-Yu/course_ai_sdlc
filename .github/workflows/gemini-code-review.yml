name: Gemini Code Review

on:
  push:
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Gemini CLI
      run: |
        npm install -g @google/gemini-cli
        
    - name: Get changed files
      run: |
        git diff --name-only HEAD~1 HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
        
    - name: Review code with Gemini
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
        
        # Debug: Show API key status without revealing the actual key
        echo "API Key status: $(if [ -n "$GEMINI_API_KEY" ]; then echo "Set (${#GEMINI_API_KEY} chars)"; else echo "Empty"; fi)"
        
        # Try to authenticate first
        echo "Testing Gemini CLI authentication..."
        echo "test" | gemini -p "Say hello" || echo "Authentication test failed"
        
        # Simple review using gemini CLI with correct syntax
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "=== Reviewing file: $file ==="
            gemini -p "請幫我 review 以下這段程式碼，指出潛在問題與改善建議：" < "$file" || echo "Review failed for $file"
            echo "================================"
          fi
        done < changed_files.txt
