name: Gemini Code Review

on:
  push:
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Gemini CLI
      run: |
        npm install -g @google/gemini-cli
        
    - name: Get changed files
      run: |
        echo "=== Git diff analysis ==="
        # Use GitHub event context to get all changes in this push
        git diff --name-only ${{ github.event.before }} ${{ github.sha }} > changed_files.txt
        echo "All changed files in this push:"
        cat changed_files.txt
        
        echo -e "\n=== File status check ==="
        while IFS= read -r file; do
          if [ -n "$file" ]; then
            if [ -f "$file" ]; then
              echo "✅ EXISTS: $file ($(wc -l < "$file") lines)"
            else
              echo "❌ MISSING: $file (deleted or moved)"
            fi
          fi
        done < changed_files.txt
        
    - name: Review code with Gemini
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # Debug: Show API key status
        echo "API Key status: $(if [ -n "$GEMINI_API_KEY" ]; then echo "Set (${#GEMINI_API_KEY} chars)"; else echo "Empty"; fi)"
        
        echo "=== Starting code review ==="
        review_count=0
        
        # Review each existing file directly from changed_files.txt
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "=== Reviewing file: $file ==="
            
            # Single method: Direct cat pipe (most reliable)
            cat "$file" | gemini -p "請依據安全程式碼開發標準，深入檢查以下程式碼，明確指出所有潛在問題（如安全性、錯誤處理、可維護性等），並針對每個問題提供具體解決方案。請將問題與修正建議以表格方式呈現，包含『問題描述』、『風險等級』、『修正建議』三欄。最後請綜合總結本次檢查發現的主要問題及建議。"
            
            review_count=$((review_count + 1))
            echo "================================"
          else
            echo "Skipping $file (not found or deleted)"
          fi
        done < changed_files.txt
        
        echo "=== Review completed: $review_count files reviewed ==="
