name: Gemini Code Review

on:
  push:
    branches: [ main, master, develop ]

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Gemini CLI
      run: |
        npm install -g @google/gemini-cli
        
    - name: Get changed files
      run: |
        git diff --name-only HEAD~1 HEAD > changed_files.txt
        echo "Changed files:"
        cat changed_files.txt
        
    - name: Review code with Gemini
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        # Debug: Check if API key is available
        if [ -z "$GEMINI_API_KEY" ]; then
          echo "❌ GEMINI_API_KEY is empty or not set"
          echo "Please check your GitHub repository secrets configuration"
          exit 1
        else
          echo "✅ GEMINI_API_KEY is available (length: ${#GEMINI_API_KEY})"
        fi
        
        export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
        
        # Simple review using gemini CLI with correct syntax
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "=== Reviewing file: $file ==="
            gemini -p "請幫我 review 以下這段程式碼，指出潛在問題與改善建議：" < "$file" || echo "Review failed for $file"
            echo "================================"
          fi
        done < changed_files.txt
